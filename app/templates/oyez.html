<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oyez JSON Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
{% include 'header.html' %}
<div class="container mt-5">
    <h2 class="mb-3"><i class="fas fa-gavel me-2"></i>Oyez JSON Viewer</h2>
    <form id="oyezForm" class="mb-4">
        <div class="input-group">
            <input type="text" class="form-control" id="oyezUrl" placeholder="Paste Oyez JSON URL (e.g. https://api.oyez.org/cases/2024/23-1)" required value="{{ oyez_url|default('') }}">
            <button class="btn btn-primary" type="submit">Fetch JSON</button>
        </div>
    </form>
    <div class="mb-3">
        <button class="btn btn-secondary" id="showKeysBtn" disabled>Show Top-Level Keys</button>
        <button class="btn btn-warning ms-2" id="aiSummaryBtn" disabled>
            <i class="fas fa-robot me-1"></i>Summarize with AI
        </button>
    </div>
     <div id="aiSummaryResult" class="alert alert-info d-none mb-4"></div>
    <div id="oyezSummary" class="mb-4"></div>
    <div id="oyezResult" class="bg-dark text-light p-3 rounded" style="min-height:200px; font-family:monospace; white-space:pre-wrap; word-break:break-all;"></div>
    <div id="oyezKeys" class="mt-3"></div>
</div>
<script>
let lastJson = null;
function renderOyezSummary(data) {
    if (!data || typeof data !== 'object') return '';
    // Pick some representative fields to show in a summary table
    const fields = [
        { label: 'Case Name', key: 'name' },
        { label: 'Docket Number', key: 'docket_number' },
        { label: 'Term', key: 'term' },
        { label: 'First Party', key: 'first_party' },
        { label: 'Second Party', key: 'second_party' },
        { label: 'Manner of Jurisdiction', key: 'manner_of_jurisdiction' },
        { label: 'Facts of the Case', key: 'facts_of_the_case' },
        { label: 'Question', key: 'question' },
        { label: 'Conclusion', key: 'conclusion' },
        { label: 'Description', key: 'description' },
        { label: 'Justia URL', key: 'justia_url', isUrl: true },
        { label: 'Oyez API Link', key: 'href', isUrl: true },
    ];
    let html = '<div class="table-responsive" style="overflow-x:auto;width:100%"><table class="table table-bordered table-dark table-striped">';
    html += '<tbody>';
    // Render Case Name as a header row
    if (data['name']) {
        html += `<tr><th colspan="2"><h3 class="mb-0">${data['name']}</h3></th></tr>`;
    }
    // Decided By & Ideology section (move up, right after Case Name)
    if (data['decided_by'] && typeof data['decided_by'] === 'object' && Array.isArray(data['decided_by'].members)) {
        const court = data['decided_by'];
        // Map ideology scores to justice names (from decisions)
        let ideologyMap = {};
        if (Array.isArray(data['decisions'])) {
            data['decisions'].forEach(decision => {
                if (Array.isArray(decision.votes)) {
                    decision.votes.forEach(vote => {
                        if (vote.member && vote.member.name && vote.ideology !== undefined && vote.ideology !== null) {
                            ideologyMap[vote.member.name] = vote.ideology;
                        }
                    });
                }
            });
        }
        // Prepare justices with ideology for plotting
        let justicesWithIdeology = court.members.map(justice => {
            return {
                name: justice.name,
                href: justice.href,
                thumbnail: justice.thumbnail && justice.thumbnail.href,
                role: justice.roles && justice.roles[0] && justice.roles[0].role_title,
                ideology: ideologyMap[justice.name]
            };
        }).filter(j => j.ideology !== undefined);
        // Sort by ideology (most negative = left, most positive = right)
        justicesWithIdeology.sort((a, b) => a.ideology - b.ideology);
        // Plot: row of thumbnails spaced by ideology
        let plotHtml = '';
        // Helper to get last name without suffixes
        function getLastNameNoSuffix(fullName) {
            if (!fullName) return '';
            let parts = fullName.trim().split(' ');
            let last = parts[parts.length - 1];
            // Remove common suffixes
            const suffixes = ['Jr', 'Jr.', 'Sr', 'Sr.', 'II', 'III', 'IV', 'V'];
            if (suffixes.includes(last.replace(/\.$/, ''))) {
                last = parts[parts.length - 2] || last;
            }
            // Remove trailing comma if present
            return last.replace(/,$/, '');
        }
        if (justicesWithIdeology.length > 0) {
            plotHtml += '<div class="d-flex justify-content-between align-items-end mb-3" style="gap:12px;overflow-x:auto;">';
            justicesWithIdeology.forEach(j => {
                plotHtml += `<div class="text-center" style="min-width:60px;">
                    <a href="${j.href}" target="_blank" rel="noopener">
                        <img src="${j.thumbnail}" alt="${j.name}" style="width:48px;height:48px;object-fit:cover;border-radius:50%;border:2px solid #888;">
                    </a><br>
                    <span class="small">${getLastNameNoSuffix(j.name)}</span><br>
                    <span class="${j.ideology > 0 ? 'text-danger' : (j.ideology < 0 ? 'text-primary' : 'text-muted')}">${j.ideology.toFixed(2)}</span>
                </div>`;
            });
            plotHtml += '</div>';
        }
        let courtHtml = plotHtml;
        courtHtml += `<b>${court.name || ''}</b>`;
        if (court.href) {
            courtHtml += ` (<a href="${court.href}" target="_blank" rel="noopener">Oyez</a>)`;
        }
        // Add toggle for the detailed justice table
        courtHtml += `
        <button class="btn btn-sm btn-outline-secondary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#justiceTableCollapse" aria-expanded="false" aria-controls="justiceTableCollapse">
            Show/Hide Justice Table
        </button>
        <div class="collapse" id="justiceTableCollapse">
            <ul class="list-group mt-2 mb-0">`;
        court.members.forEach(justice => {
            courtHtml += `<li class="list-group-item bg-dark text-light border-secondary d-flex align-items-center">`;
            if (justice.thumbnail && justice.thumbnail.href) {
                courtHtml += `<img src="${justice.thumbnail.href}" alt="${justice.name}" style="width:32px;height:32px;object-fit:cover;border-radius:50%;margin-right:8px;">`;
            }
            courtHtml += `<a href="${justice.href}" target="_blank" rel="noopener" class="text-info">${justice.name}</a>`;
            if (justice.roles && justice.roles[0] && justice.roles[0].role_title) {
                courtHtml += ` <span class="text-muted small ms-2">(${justice.roles[0].role_title})</span>`;
            }
            // Show ideology score if available
            if (ideologyMap[justice.name] !== undefined) {
                let score = ideologyMap[justice.name];
                let color = score > 0 ? 'text-danger' : (score < 0 ? 'text-primary' : 'text-muted');
                courtHtml += ` <span class="ms-2 ${color}">[${score.toFixed(2)}]</span>`;
            }
            courtHtml += '</li>';
        });
        courtHtml += '</ul></div>';
        html += `<tr><th>Decided By & Ideology</th><td>${courtHtml}</td></tr>`;
    }
    // Render all fields except Case Name, Justia URL, Oyez API Link, and written_opinion
    fields.forEach(f => {
        if (f.key === 'name' || f.key === 'justia_url' || f.key === 'href' || f.key === 'written_opinion') return;
        let val = data[f.key];
        if (val === undefined || val === null || val === '') return;
        if (f.isUrl) {
            val = `<a href="${val}" target="_blank" rel="noopener">${val}</a>`;
        } else if (typeof val === 'string' && val.length > 300) {
            val = val.slice(0, 300) + 'â€¦';
        }
        html += `<tr><th>${f.label}</th><td>${val}</td></tr>`;
    });
    // Render Justia URL and Oyez API Link at the end
    ['justia_url', 'href'].forEach(key => {
        let f = fields.find(f => f.key === key);
        if (!f) return;
        let val = data[key];
        if (val === undefined || val === null || val === '') return;
        if (f.isUrl) {
            val = `<a href="${val}" target="_blank" rel="noopener">${val}</a>`;
        }
        html += `<tr><th>${f.label}</th><td>${val}</td></tr>`;
    });
    // Written Opinions at the very end
    if (Array.isArray(data['written_opinion']) && data['written_opinion'].length > 0) {
        // Sort so 'Opinion of the Court' (majority) comes first
        const sortedOpinions = data['written_opinion'].slice().sort((a, b) => {
            const getType = op => (op.type && op.type.value) || '';
            if (getType(a) === 'majority') return -1;
            if (getType(b) === 'majority') return 1;
            return 0;
        });
        let opinionsHtml = '<ul class="list-group mb-3">';
        sortedOpinions.forEach(op => {
            opinionsHtml += '<li class="list-group-item bg-dark text-light border-secondary">';
            if (op.type && op.type.label) {
                opinionsHtml += `<b>${op.type.label}</b> `;
            } else if (op.title) {
                opinionsHtml += `<b>${op.title}</b> `;
            }
            if (op.judge_full_name) {
                opinionsHtml += `by <span class="text-info">${op.judge_full_name}</span> `;
            }
            if (op.justia_opinion_url) {
                opinionsHtml += `<a href="${op.justia_opinion_url}" target="_blank" rel="noopener">[Justia]</a> `;
            }
            if (op.href) {
                opinionsHtml += `<a href="${op.href}" target="_blank" rel="noopener">[Oyez]</a>`;
            }
            opinionsHtml += '</li>';
        });
        opinionsHtml += '</ul>';
        html += `<tr><th>Written Opinions</th><td>${opinionsHtml}</td></tr>`;
    }
    html += '</tbody></table></div>';
    return html;
}
document.getElementById('oyezForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const url = document.getElementById('oyezUrl').value.trim();
    const resultDiv = document.getElementById('oyezResult');
    const showKeysBtn = document.getElementById('showKeysBtn');
    const keysDiv = document.getElementById('oyezKeys');
    resultDiv.textContent = 'Loading...';
    keysDiv.innerHTML = '';
    showKeysBtn.disabled = true;
    fetch(url)
        .then(resp => {
            if (!resp.ok) throw new Error('Failed to fetch JSON');
            return resp.json();
        })
        .then(data => {
            lastJson = data;
            resultDiv.textContent = JSON.stringify(data, null, 2);
            resultDiv.style.display = '';
            document.getElementById('oyezSummary').innerHTML = '';
            showKeysBtn.disabled = false;
            document.getElementById('oyezSummary').innerHTML = renderOyezSummary(data);
            document.getElementById('aiSummaryBtn').disabled = false;
        })
        .catch(err => {
            resultDiv.textContent = 'Error: ' + err.message;
            lastJson = null;
            showKeysBtn.disabled = true;
            document.getElementById('oyezSummary').innerHTML = '';
        });
});
document.getElementById('showKeysBtn').addEventListener('click', function() {
    const keysDiv = document.getElementById('oyezKeys');
    const resultDiv = document.getElementById('oyezResult');
    if (lastJson && typeof lastJson === 'object') {
        // Hide the JSON display when showing keys
        resultDiv.style.display = 'none';
        const keys = Object.keys(lastJson);
        let html = '<b>Top-level keys:</b><ul class="list-group mb-2">';
        keys.forEach(key => {
            let val = lastJson[key];
            let valType = typeof val;
            let displayVal;
            if (val === null) {
                displayVal = '<span class="text-muted">null</span>';
            } else if (Array.isArray(val)) {
                displayVal = `<span class="text-info">Array[${val.length}]</span>`;
            } else if (valType === 'object') {
                displayVal = '<span class="text-info">Object</span>';
            } else if (valType === 'string') {
                displayVal = `<span class="text-success">'${val.length > 60 ? val.slice(0,60)+'â€¦' : val}'</span>`;
            } else {
                displayVal = `<span class="text-warning">${val}</span>`;
            }
            html += `<li class="list-group-item bg-dark text-light border-secondary d-flex justify-content-between align-items-center"><span>${key}</span><span>${displayVal}</span></li>`;
        });
        html += '</ul>';
        keysDiv.innerHTML = html;
    } else {
        keysDiv.innerHTML = '<span class="text-danger">No JSON loaded.</span>';
    }
});
// Show JSON again if a new fetch is made
document.getElementById('oyezForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const url = document.getElementById('oyezUrl').value.trim();
    const resultDiv = document.getElementById('oyezResult');
    const showKeysBtn = document.getElementById('showKeysBtn');
    const keysDiv = document.getElementById('oyezKeys');
    resultDiv.textContent = 'Loading...';
    keysDiv.innerHTML = '';
    showKeysBtn.disabled = true;
    fetch(url)
        .then(resp => {
            if (!resp.ok) throw new Error('Failed to fetch JSON');
            return resp.json();
        })
        .then(data => {
            lastJson = data;
            resultDiv.textContent = JSON.stringify(data, null, 2);
            resultDiv.style.display = '';
            document.getElementById('oyezSummary').innerHTML = '';
            showKeysBtn.disabled = false;
            document.getElementById('oyezSummary').innerHTML = renderOyezSummary(data);
        })
        .catch(err => {
            resultDiv.textContent = 'Error: ' + err.message;
            lastJson = null;
            showKeysBtn.disabled = true;
            document.getElementById('oyezSummary').innerHTML = '';
        });
});
document.getElementById('aiSummaryBtn').addEventListener('click', function() {
    if (!lastJson) return;
    // Extract summary and ideology scores from lastJson
    let summary = '';
    if (lastJson['description']) summary += lastJson['description'] + '\n';
    if (lastJson['facts_of_the_case']) summary += lastJson['facts_of_the_case'] + '\n';
    if (lastJson['conclusion']) summary += lastJson['conclusion'] + '\n';
    // Ideology scores
    let ideology_scores = [];
    if (lastJson['decided_by'] && Array.isArray(lastJson['decided_by'].members)) {
        const court = lastJson['decided_by'];
        let ideologyMap = {};
        if (Array.isArray(lastJson['decisions'])) {
            lastJson['decisions'].forEach(decision => {
                if (Array.isArray(decision.votes)) {
                    decision.votes.forEach(vote => {
                        if (vote.member && vote.member.name && vote.ideology !== undefined && vote.ideology !== null) {
                            ideologyMap[vote.member.name] = vote.ideology;
                        }
                    });
                }
            });
        }
        ideology_scores = court.members.map(justice => ({
            name: justice.name,
            ideology: ideologyMap[justice.name]
        })).filter(j => j.ideology !== undefined);
    }
    const btn = document.getElementById('aiSummaryBtn');
    const resultDiv = document.getElementById('aiSummaryResult');
    btn.disabled = true;
    resultDiv.classList.remove('d-none', 'alert-danger');
    resultDiv.classList.add('alert-info');
    resultDiv.textContent = 'Generating summary...';
    fetch('/api/oyez-summary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ summary, ideology_scores })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.summary) {
            let summaryText = data.summary;
            // Try to parse as JSON if possible
            let rendered = '';
            try {
                const parsed = JSON.parse(summaryText);
                if (parsed.choices && Array.isArray(parsed.choices) && parsed.choices[0].text) {
                    let aiText = parsed.choices[0].text.trim();
                    // Remove leading 'Use this format:' and following newlines if present
                    aiText = aiText.replace(/^Use this format:\s*\n?/i, '');
                    // Remove trailing 'Stop reason: stop' and anything after
                    aiText = aiText.split(/Stop reason: stop/i)[0].trim();
                    rendered += '<div class="mb-2"><b>AI Summary:</b></div>';
                    rendered += `<div class=\"mb-2\" style=\"white-space:pre-wrap;word-break:break-word;overflow-x:auto;max-width:100%\"><span>${aiText}</span></div>`;
                } else {
                    rendered = `<div style=\"white-space:pre-wrap;word-break:break-word;max-width:100%\"><span>${summaryText}</span></div>`;
                }
            } catch (e) {
                rendered = `<div style=\"white-space:pre-wrap;word-break:break-word;max-width:100%\"><span>${summaryText}</span></div>`;
            }
            resultDiv.innerHTML = rendered;
        } else {
            resultDiv.textContent = 'No summary returned.';
        }
    })
    .catch(err => {
        resultDiv.textContent = 'Error: ' + err.message;
        resultDiv.classList.remove('alert-info');
        resultDiv.classList.add('alert-danger');
    })
    .finally(() => {
        btn.disabled = false;
    });
});
document.addEventListener('DOMContentLoaded', function() {
    const oyezUrlInput = document.getElementById('oyezUrl');
    if (oyezUrlInput && oyezUrlInput.value) {
        // Auto-submit the form if the input is pre-filled (from /oyez?year=...&docket=...)
        document.getElementById('oyezForm').dispatchEvent(new Event('submit'));
    }
});
</script>
{% include 'footer.html' %}

<script src="/static/js/main.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
